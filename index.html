<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Football free zone visualizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="js/paper-full.min.js"></script>
    <script type="text/javascript" src="js/free-zones.js"></script>
    <script type="text/paperscript" canvas="myCanvas">
        var playerSvgData = "M399.556,77.384c-28.3-14.5-57.4-26.7-87.2-37.5c-4.2-8.8-19.5-9-27.6-8c-14.801,2-29.9,4-44.7,4.3" +
            "c-14.8-0.3-29.9-2.3-44.7-4.3c-8-1.1-23.4-0.8-27.6,8c-29.9,10.9-58.9,23-87.2,37.5c-6.8,3.5-82.9,45-80.5,49" +
            "c11.3,18.8,56.6,103.1,62.2,103.1c7.9,0,21.3-14.5,28.6-11.9c0.4,16.8,1.1,211.4,1.1,222.6c0,7.1,83.1,8.301,148,8.301" +
            "c65,0,148-1.201,148-8.301c0.1-11.299,0.699-205.8,1.1-222.6c7.3-2.6,20.7,11.9,28.6,11.9c5.601,0,50.9-84.3,62.2-103.1" +
            "C482.355,122.484,406.355,80.884,399.556,77.384z M135.756,426.184h-24v-31.5h24V426.184z M216.156,237.184c0,0.8-0.7,1.5-1.5,1.5" +
            "h-23.8c-0.8,0-1.5-0.7-1.5-1.5v-59.2c0-1.2-1.4-2-2.4-1.2c-3.5,2.5-6.9,4.6-10.2,6.2c-3.6,1.8-8.1,3.6-13.3,5.3c-1,0.3-2-0.4-2-1.5" +
            "v-18.6c0-0.7,0.4-1.2,1.1-1.5c8.5-2.8,15.2-6.2,20-10.2c4.8-3.9,8.5-8.7,11.3-14.3c0.3-0.5,0.8-0.9,1.4-0.9h19.5" +
            "c0.8,0,1.5,0.7,1.5,1.5v94.4H216.156z M305.355,237.184c0,0.8-0.7,1.5-1.5,1.5h-23.8c-0.8,0-1.5-0.7-1.5-1.5v-59.2" +
            "c0-1.2-1.4-2-2.4-1.2c-3.5,2.5-6.899,4.6-10.2,6.2c-3.6,1.8-8.1,3.6-13.3,5.3c-1,0.3-2-0.4-2-1.5v-18.6c0-0.7,0.4-1.2,1.101-1.5" +
            "c8.5-2.8,15.199-6.2,20-10.2c4.8-3.9,8.5-8.7,11.3-14.3c0.3-0.5,0.8-0.9,1.399-0.9h19.501c0.8,0,1.5,0.7,1.5,1.5v94.4H305.355z";
        var freeZonePath = new Path({
            fillColor: 'rgba(0, 128, 0, 0.66)',
            closed: true
        });
        freeZonePath.closed = true;
        var i, player, team1 = [], team2 = [];
        for (i = 0; i < 8; i++) {
            team1.push(new Shape.Circle({
                center: new Point(i * 80 + 40, 40),
                radius: 30,
                fillColor: 'rgba(28, 117, 188)',
                player: true
            }));
            /*var playerPath = new Path(playerSvgData);
            playerPath.fillColor = 'rgba(28, 117, 188)';
            playerPath.scale(0.1);
            team1.push(new Group({
                children: [
                    playerPath,
                    new Shape.Circle({
                        radius: 30,
                        center: new Point(0, 0),
                        fillColor: 'rgba(28, 117, 188)',
                        player: true
                    })
                ],
                position: new Point(i * 80 + 40, 40)
            }));*/
        }
        for (i = 0; i < 8; i++) {
            team2.push(new Shape.Circle({
                center: new Point(i * 80 + 40, 100),
                radius: 30,
                fillColor: 'rgba(255, 128, 0)',
                player: true
            }));
        }

        team1[0].ball = true;
        /*team1[0].addChild(new Shape.Circle({
            center: new Point(30, 30),
            radius: 5,
            fillColor: 'black'
        }));*/
        calculateFreeZones();

        player = null;
        var hitOptions = {
            fill: true,
            tolerance: 5
        };

        function onMouseDown(event) {
            player = null;
            var hitResult = project.hitTest(event.point, hitOptions);
            if (!hitResult) {
                return;
            }

            if (hitResult) {
                if (hitResult.type === 'fill' && hitResult.item.player) {
                    player = hitResult.item;
                }
            }
        }

        function onMouseMove(event) {
            project.activeLayer.selected = false;
            if (event.item && event.item.player) {
                event.item.selected = true;
            }
        }

        function onMouseDrag(event) {
            if (!player) {
                return;
            }

            player.position += event.delta;

            calculateFreeZones();
        }

        function onResize(event) {
            calculateFreeZones();
        }

        function calculateFreeZones() {
            var i, j;
            var twoPi = 2 * Math.PI;
            var bounds = project.view.bounds;
            var ballPosition = team1[0].position;
            var maxDistance = 0;
            maxDistance = Math.max(maxDistance, ballPosition.getDistance(bounds.topLeft));
            maxDistance = Math.max(maxDistance, ballPosition.getDistance(bounds.topRight));
            maxDistance = Math.max(maxDistance, ballPosition.getDistance(bounds.bottomLeft));
            maxDistance = Math.max(maxDistance, ballPosition.getDistance(bounds.bottomRight));
            var freeZones = [
                {
                    start: 0,
                    end: twoPi,
                    radius: maxDistance
                }
            ];

            for (i = 0; i < team2.length; i++) {
                var team2Player = team2[i];
                var distance = ballPosition.getDistance(team2Player.position)
                var angle = (team2Player.position - ballPosition). angleInRadians;
                if (angle < 0) {
                    angle = twoPi + angle;
                }
                var addAngle = new Point(distance, team2Player.bounds.width / 2).angleInRadians;
                var start = angle - addAngle;
                var end = angle + addAngle;

                if (start < 0) {
                    addFreeZone(freeZones, {
                        start: twoPi + start,
                        end: twoPi,
                        radius: distance
                    });
                    start = 0;
                }
                if (end > twoPi) {
                    addFreeZone(freeZones, {
                        start: 0,
                        end: end - twoPi,
                        radius: distance
                    });
                    end = twoPi;
                }
                addFreeZone(freeZones, {
                    start: start,
                    end: end,
                    radius: distance
                });
            }

            var segments = [];
            var boundLines = [
                new Line(bounds.topRight, bounds.bottomRight),
                new Line(bounds.bottomRight, bounds.bottomLeft),
                new Line(bounds.bottomLeft, bounds.topLeft),
                new Line(bounds.topLeft, bounds.topRight)
            ];
            segments.push(ballPosition);
            /*var clampedPoint1 = clampToBounds(ballPosition, new Point(
                    ballPosition.x + Math.cos(Math.PI) * 2000,
                    ballPosition.y + Math.sin(Math.PI) * 2000),
                boundLines);
            var clampedPoint2 = clampToBounds(ballPosition, new Point(
                    ballPosition.x + Math.cos(Math.PI * 2) * 2000,
                    ballPosition.y + Math.sin(Math.PI * 2) * 2000),
                boundLines);*/
            for (i = 0; i < freeZones.length; i++) {
                var freeZone = freeZones[i];
                var clampedPoint1 = clampToBounds(ballPosition, new Point(
                        ballPosition.x + Math.cos(freeZone.start) * freeZone.radius,
                        ballPosition.y + Math.sin(freeZone.start) * freeZone.radius),
                    boundLines);
                var clampedPoint2 = clampToBounds(ballPosition, new Point(
                        ballPosition.x + Math.cos(freeZone.end) * freeZone.radius,
                        ballPosition.y + Math.sin(freeZone.end) * freeZone.radius),
                    boundLines);
                segments.push(clampedPoint1.point);
                if (clampedPoint1.index !== undefined
                    && clampedPoint2.index !== undefined
                    && clampedPoint1.index !== clampedPoint2.index) {
                    if (clampedPoint1.index < clampedPoint2.index) {
                        for (j = clampedPoint1.index + 1; j <= clampedPoint2.index; j++) {
                            segments.push(boundLines[j].point)
                        }
                    } else {
                        for (j = clampedPoint1.index; j !== clampedPoint2.index;) {
                            j++;
                            if (j >= boundLines.length) {
                                j = 0;
                            }
                            segments.push(boundLines[j].point);
                        }
                    }
                }
                segments.push(clampedPoint2.point);
            }
            freeZonePath.removeSegments();
            freeZonePath.addSegments(segments);
        }

        function clampToBounds(startPoint, finishPoint, boundLines) {
            var line = new Line(startPoint, finishPoint);
            for (var j = 0; j < boundLines.length; j++) {
                var inter = line.intersect(boundLines[j]);
                if (inter) {
                    return {
                        point: inter,
                        index: j
                    };
                }
            }

            return {
                point: finishPoint,
                index: undefined
            };
        }
    </script>
    <style>
        canvas[resize] {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<canvas id="myCanvas" resize="resize"></canvas>
</body>
</html>
