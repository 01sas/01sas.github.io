<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Football free zone visualizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="js/paper-full.min.js"></script>
    <script type="text/javascript" src="js/free-zones.js"></script>
    <script type="text/paperscript" canvas="myCanvas">
        var freeZonePath = new Path({
            fillColor: 'rgba(0, 128, 0, 0.66)',
            closed: true
        });
        freeZonePath.closed = true;
        var i, player, team1 = [], team2 = [];
        for (i = 0; i < 8; i++) {
            team1.push(new Shape.Circle({
                center: new Point(i * 80 + 40, 40),
                radius: 30,
                fillColor: 'rgba(28, 117, 188, 0.66)'
            }));
        }
        for (i = 0; i < 8; i++) {
            team2.push(new Shape.Circle({
                center: new Point(i * 80 + 40, 100),
                radius: 30,
                fillColor: 'rgba(255, 128, 0, 0.66)'
            }));
        }

        team1[0].ball = true;
        calculateFreeZones();

        player = null;
        var hitOptions = {
            fill: true,
            tolerance: 5
        };

        function onMouseDown(event) {
            player = null;
            var hitResult = project.hitTest(event.point, hitOptions);
            if (!hitResult) {
                return;
            }

            if (hitResult) {
                if (hitResult.type === 'fill') {
                    player = hitResult.item;
                }
            }
        }

        function onMouseMove(event) {
            project.activeLayer.selected = false;
            if (event.item) {
                event.item.selected = true;
            }
        }

        function onMouseDrag(event) {
            if (!player) {
                return;
            }

            player.position += event.delta;

            calculateFreeZones();
        }

        function calculateFreeZones() {
            var i, j;
            var twoPi = 2 * Math.PI;
            var bounds = project.view.bounds;
            var ballPosition = team1[0].position;
            var maxDistance = 0;
            maxDistance = Math.max(maxDistance, ballPosition.getDistance(bounds.topLeft));
            maxDistance = Math.max(maxDistance, ballPosition.getDistance(bounds.topRight));
            maxDistance = Math.max(maxDistance, ballPosition.getDistance(bounds.bottomLeft));
            maxDistance = Math.max(maxDistance, ballPosition.getDistance(bounds.bottomRight));
            var freeZones = [
                {
                    start: 0,
                    end: twoPi,
                    radius: maxDistance
                }
            ];

            for (i = 0; i < team2.length; i++) {
                var team2Player = team2[i];
                var distance = ballPosition.getDistance(team2Player.position)
                var angle = (team2Player.position - ballPosition). angleInRadians;
                if (angle < 0) {
                    angle = twoPi + angle;
                }
                var addAngle = new Point(distance, team2Player.bounds.width / 2).angleInRadians;
                var start = angle - addAngle;
                var end = angle + addAngle;

                if (start < 0) {
                    addFreeZone(freeZones, {
                        start: twoPi + start,
                        end: twoPi,
                        radius: distance
                    });
                    start = 0;
                }
                if (end > twoPi) {
                    addFreeZone(freeZones, {
                        start: 0,
                        end: end - twoPi,
                        radius: distance
                    });
                    end = twoPi;
                }
                addFreeZone(freeZones, {
                    start: start,
                    end: end,
                    radius: distance
                });
            }

            var segments = [];
            var boundLines = [
                new Line(bounds.topRight, bounds.bottomRight),
                new Line(bounds.bottomRight, bounds.bottomLeft),
                new Line(bounds.bottomLeft, bounds.topLeft),
                new Line(bounds.topLeft, bounds.topRight)
            ];
            //segments.push(ballPosition);
            //var clampedPoint1 = clampToBounds(ballPosition, new Point(- 100, 100), boundLines);
            //var clampedPoint2 = clampToBounds(ballPosition, new Point(100, - 100), boundLines);
            //var clampedPoint1 = clampToBounds(ballPosition, new Point(bounds.right + 100, 100), boundLines);
            //var clampedPoint2 = clampToBounds(ballPosition, new Point(bounds.right + 100, 100), boundLines);
            //var clampedPoint2 = clampToBounds(ballPosition, new Point(-100, 100), boundLines);
            //var clampedPoint1 = clampToBounds(ballPosition, new Point(bounds.right - 100, bounds.bottom + 100), boundLines);
            //var clampedPoint2 = clampToBounds(ballPosition, new Point(bounds.right + 100, bounds.bottom - 100), boundLines);
            //var clampedPoint1 = clampToBounds(ballPosition, new Point(- 100, bounds.bottom - 100), boundLines);
            //var clampedPoint2 = clampToBounds(ballPosition, new Point(100, bounds.bottom + 100), boundLines);
            //var clampedPoint1 = clampToBounds(ballPosition, new Point(-100, -100), boundLines);
            //var clampedPoint2 = clampToBounds(ballPosition, new Point(-100, bounds.bottom + 100), boundLines);
            //segments.push(clampedPoint1.point);
            //segments.push(clampedPoint2.point);
            //console.log(segments);
            for (i = 0; i < freeZones.length; i++) {
                var freeZone = freeZones[i];
                var clampedPoint1 = clampToBounds(ballPosition, new Point(
                        ballPosition.x + Math.cos(freeZone.start) * freeZone.radius,
                        ballPosition.y + Math.sin(freeZone.start) * freeZone.radius),
                    boundLines);
                var clampedPoint2 = clampToBounds(ballPosition, new Point(
                        ballPosition.x + Math.cos(freeZone.end) * freeZone.radius,
                        ballPosition.y + Math.sin(freeZone.end) * freeZone.radius),
                    boundLines);
                segments.push(clampedPoint1.point);
                if (clampedPoint1.index !== undefined
                    && clampedPoint2.index !== undefined
                    && clampedPoint1.index !== clampedPoint2.index) {
                    if (clampedPoint1.index < clampedPoint2.index) {
                        for (j = clampedPoint1.index + 1; j <= clampedPoint2.index; j++) {
                            segments.push(boundLines[j].point)
                        }
                    } else {
                        for (j = clampedPoint1.index - 1; j >= clampedPoint2.index; j--) {
                            segments.push(boundLines[j].point + boundLines[j].vector)
                        }
                    }
                }
                segments.push(clampedPoint2.point);
            }
            freeZonePath.removeSegments();
            freeZonePath.addSegments(segments);
        }

        function clampToBounds(startPoint, finishPoint, boundLines) {
            var line = new Line(startPoint, finishPoint);
            for (var j = 0; j < boundLines.length; j++) {
                var inter = line.intersect(boundLines[j]);
                if (inter) {
                    return {
                        point: inter,
                        index: j
                    };
                }
            }

            return {
                point: finishPoint,
                index: undefined
            };
        }
    </script>
    <style>
        canvas[resize] {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<canvas id="myCanvas" resize="resize"></canvas>
</body>
</html>
